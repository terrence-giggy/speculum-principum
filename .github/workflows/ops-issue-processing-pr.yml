name: Operations -3 Issue Processing
permissions:
  contents: write  # Required for creating branches and PRs
  issues: write
  pull-requests: write

on:
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to process (optional)'
        required: false
        type: number
      dry_run:
        description: 'Perform dry run without making changes'
        required: false
        type: boolean
        default: true

jobs:
  check-issues:
    name: Check for Site Monitor Issues
    runs-on: ubuntu-latest
    outputs:
      issues_to_process: ${{ steps.find-issues.outputs.issues }}
      should_process: ${{ steps.find-issues.outputs.should_process }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Find issues to process
        id: find-issues
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
        run: |
          # Python script to find issues and output JSON
          ISSUES_JSON=$(python3 << 'EOF'
          import os
          import json
          import sys
          from github import Github
          
          def main():
              token = os.environ.get('GITHUB_TOKEN')
              repo_name = os.environ.get('GITHUB_REPOSITORY')
              
              if not token or not repo_name:
                  print("Missing required environment variables", file=sys.stderr)
                  sys.exit(1)
              
              g = Github(token)
              repo = g.get_repo(repo_name)
              
              issues_to_process = []
              
              if os.environ.get('GITHUB_EVENT_NAME') == 'issues':
                  event_path = os.environ.get('GITHUB_EVENT_PATH')
                  if event_path and os.path.exists(event_path):
                      with open(event_path, 'r') as f:
                          event_data = json.load(f)
                      
                      issue = event_data.get('issue', {})
                      labels = [label['name'] for label in issue.get('labels', [])]
                      
                      if 'site-monitor' in labels:
                          issues_to_process.append({
                              'number': issue['number'],
                              'title': issue['title'],
                              'labels': labels
                          })
              else:
                  site_monitor_issues = repo.get_issues(
                      state='open',
                      labels=['site-monitor']
                  )
                  
                  for issue in site_monitor_issues:
                      if issue.assignee and issue.assignee.login == 'github-actions[bot]':
                          continue
                      
                      issues_to_process.append({
                          'number': issue.number,
                          'title': issue.title,
                          'labels': [label.name for label in issue.labels]
                      })
              
              # Output JSON to stdout for shell capture
              issues_json = json.dumps(issues_to_process) if issues_to_process else "[]"
              print(issues_json)
              
              # Also print debug info to stderr
              print(f"DEBUG: Found {len(issues_to_process)} issues", file=sys.stderr)
              if issues_to_process:
                  for issue in issues_to_process:
                      print(f"  - #{issue['number']}: {issue['title']}", file=sys.stderr)
          
          if __name__ == '__main__':
              main()
          EOF
          )
          
          # Set outputs using shell commands
          echo "issues=${ISSUES_JSON}" >> $GITHUB_OUTPUT
          
          # Check if we should process (non-empty array)
          if [ "${ISSUES_JSON}" = "[]" ]; then
            echo "should_process=false" >> $GITHUB_OUTPUT
            echo "No issues found to process"
          else
            echo "should_process=true" >> $GITHUB_OUTPUT
            echo "Found issues to process: ${ISSUES_JSON}"
          fi

  process-issues:
    name: Process Issues
    runs-on: ubuntu-latest
    needs: check-issues
    if: needs.check-issues.outputs.should_process == 'true'
    
    strategy:
      matrix:
        issue: ${{ fromJson(needs.check-issues.outputs.issues || '[]') }}
      fail-fast: false
      max-parallel: 3
    
    steps:
      - name: Debug matrix values
        run: |
          echo "DEBUG: Matrix issue data:"
          echo "  Number: ${{ matrix.issue.number }}"
          echo "  Title: ${{ matrix.issue.title }}"
          echo "  Labels: ${{ toJson(matrix.issue.labels) }}"
      
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Configure Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Set up environment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_SEARCH_ENGINE_ID: ${{ secrets.GOOGLE_SEARCH_ENGINE_ID }}
        run: |
          cat > .env << EOF
          GITHUB_TOKEN=${GITHUB_TOKEN}
          GOOGLE_API_KEY=${GOOGLE_API_KEY}
          GOOGLE_SEARCH_ENGINE_ID=${GOOGLE_SEARCH_ENGINE_ID}
          EOF
      
      - name: Process issue
        id: process
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ matrix.issue.number }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          echo "Processing issue #${ISSUE_NUMBER}: ${{ matrix.issue.title }}"
          
          if [ "${DRY_RUN}" = "true" ]; then
            DRY_RUN_FLAG="--dry-run"
            echo "Running in dry-run mode"
          else
            DRY_RUN_FLAG=""
            echo "Running in live mode"
          fi
          
          python main.py process-issues \
            --config config.yaml \
            --issue ${ISSUE_NUMBER} \
            ${DRY_RUN_FLAG}
      
      - name: Create Pull Request
        if: success() && github.event.inputs.dry_run != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ matrix.issue.number }}
        run: |
          # Check if there are any changes
          if [ -n "$(git status --porcelain)" ]; then
            echo "Changes detected, creating PR..."
            
            # Create a new branch for this issue
            BRANCH_NAME="automated/issue-${ISSUE_NUMBER}-$(date +%s)"
            git checkout -b "${BRANCH_NAME}"
            
            # Add and commit changes
            git add .
            git commit -m "docs: automated processing for issue #${ISSUE_NUMBER}" \
                       -m "- Generated deliverables for issue #${ISSUE_NUMBER}" \
                       -m "- Applied workflow-based document generation" \
                       -m "- Automated via GitHub Actions"
            
            # Push the branch
            git push origin "${BRANCH_NAME}"
            
            # Create pull request using template
            envsubst < .github/templates/pr-body-issue-processing.md > pr_body.txt
            
            gh pr create \
              --title "Automated processing for issue #${ISSUE_NUMBER}" \
              --body-file pr_body.txt \
              --head "${BRANCH_NAME}" \
              --base main \
              --assignee "@me"
            
            echo "Pull request created successfully"
          else
            echo "No changes to commit"
          fi

      - name: Report processing results
        if: always()
        env:
          ISSUE_NUMBER: ${{ matrix.issue.number }}
          JOB_STATUS: ${{ job.status }}
        run: |
          echo "Issue #${ISSUE_NUMBER} processing completed with status: ${JOB_STATUS}"
          
          if [ "${JOB_STATUS}" = "success" ]; then
            echo "✅ Successfully processed issue #${ISSUE_NUMBER}"
          else
            echo "❌ Failed to process issue #${ISSUE_NUMBER}"
          fi